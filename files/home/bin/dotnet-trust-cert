#!/usr/bin/env bash
set -eu
org=localhost-ca
domain=localhost

mkdir -p /tmp/dotnet-cert
cd /tmp/dotnet-cert

openssl genpkey -algorithm RSA -out ca.key
openssl req -x509 -key ca.key -out ca.crt \
	-subj "/CN=$org/O=$org"

openssl genpkey -algorithm RSA -out "$domain".key
openssl req -new -key "$domain".key -out "$domain".csr \
	-subj "/CN=$domain/O=$org"

openssl x509 -req -in "$domain".csr -days 365 -out "$domain".crt \
	-CA ca.crt -CAkey ca.key -CAcreateserial \
	-extfile <(
		cat <<END
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
subjectAltName = DNS:$domain
END
	)

openssl pkcs12 -export -out "$domain".pfx -inkey "$domain".key -in "$domain".crt

sudo trust anchor ca.crt

mkdir -p ~/.aspnet
mv ./* ~/.aspnet/

# add the following to bashrc
# export ASPNETCORE_Kestrel__Certificates__Default__Password=""
# export ASPNETCORE_Kestrel__Certificates__Default__Path="~/.aspnet/localhost.pfx"

# vim:tw=78:ts=8:noet:ft=sh:norl:
