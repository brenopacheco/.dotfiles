#!/bin/sh

WIN_ID=$(xprop -root | grep -e "^_NET_ACTIVE_WINDOW" | cut -d ' ' -f 5)
PID=$(xprop -id $WIN_ID | grep -e "^_NET_WM_PID" | cut -d ' ' -f 3)
get_tmux() {
	local pid=$1
	local tids=$(ls /proc/$pid/task 2>/dev/null)
	for tid in $tids; do
		if [ -e /proc/$pid/task/$tid/children ]; then
			local children=$(cat /proc/$pid/task/$tid/children)
			for p in $children; do
				local name=$(ps -p $p -o comm=)
				ps -p $p -o comm= | grep -q "tmux"
				if [[ $? -eq 0 ]]; then
					echo "$p"
				fi
				get_tmux $p
			done
		fi
	done
}

TMUX_PID="$(get_tmux $PID)"

if [[ -z "$TMUX_PID" ]]; then
	notify-send -t 3000 -u critical "tmux-dwm" "No tmux session on focus"
	exit 1
fi

TTY=/dev/$(ps -o tty= -p $TMUX_PID)

session=$(tmux list-clients | grep -e "^$TTY:" | cut -f2 -d' ')
windows=($(tmux list-windows -t $session | sed 's/:.*//' | tr '\n' ' '))

# https://github.com/saysjonathan/dwm.tmux/tree/master

window_panes=
killlast=
mfact=

newpane() {
  tmux \
    split-window -t :.0\; \
    swap-pane -s :.0 -t :.1\; \
    select-layout main-vertical\; \
    resize-pane -t :.0 -x ${mfact}%
}

# TODO: 
killpane() {
  if [ $window_panes -gt 1 ]; then
    tmux kill-pane -t :.\; \
         select-layout main-vertical\; \
         resize-pane -t :.0 -x ${mfact}%
  else
    if [ $killlast -ne 0 ]; then
      tmux kill-window
    fi
  fi
}

# TODO: 
nextpane() {
  tmux select-pane -t :.+
}

# TODO: 
prevpane() {
  tmux select-pane -t :.-
}

# TODO: 
zoom() {
  tmux swap-pane -s :. -t :.0\; select-pane -t :.0
}

# TODO: 
layouttile() {
  tmux select-layout main-vertical\; resize-pane -t :.0 -x ${mfact}%
}

# TODO: 
fullscreen() {
  tmux resize-pane -Z
}

# TODO: 
incmfact() {
  fact=$((mfact + 5))
  if [ $fact -le 95 ]; then
    tmux \
      setenv mfact $fact\; \
      resize-pane -t :.0 -x ${fact}%
  fi
}

# TODO: 
decmfact() {
  fact=$((mfact - 5))
  if [ $fact -ge 5 ]; then
    tmux \
      setenv mfact $fact\; \
      resize-pane -t :.0 -x ${fact}%
  fi
}

view() {
  idx=$(($1 - 1))
  win=${windows[$idx]}
  if [ ! -z "$win" ]; then
    tmux selectw -t $win
  fi
}

if [ $# -lt 1 ]; then
  echo "tmux-dwm [command]"
  exit
fi

command=$1
args=$2

case $command in
  newpane) newpane;;
  killpane) killpane;;
  nextpane) nextpane;;
  prevpane) prevpane;;
  zoom) zoom;;
  layouttile) layouttile;;
  fullscreen) fullscreen;;
  incmfact) incmfact;;
  decmfact) decmfact;;
  view) view $args;;
  *) echo "unknown command"; exit 1;;
esac
